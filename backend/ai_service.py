import google.generativeai as genai
import os
from typing import Optional
import asyncio
from PIL import Image

class AIService:
    def __init__(self):
        # Configure Gemini API
        api_key = os.getenv("GEMINI_API_KEY")
        if not api_key:
            print("Warning: GEMINI_API_KEY not found in environment variables")
        
        genai.configure(api_key=api_key)
        
        # Configure safety settings
        safety_settings = [
            {
                "category": "HARM_CATEGORY_HARASSMENT",
                "threshold": "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
                "category": "HARM_CATEGORY_HATE_SPEECH",
                "threshold": "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
                "category": "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                "threshold": "BLOCK_MEDIUM_AND_ABOVE"
            },
            {
                "category": "HARM_CATEGORY_DANGEROUS_CONTENT",
                "threshold": "BLOCK_MEDIUM_AND_ABOVE"
            }
        ]
        
        # Configure generation config
        generation_config = {
            "temperature": 0.3,  # Lower temperature for more precise math responses
            "top_p": 1,
            "top_k": 1,
            # "max_output_tokens": 2048,
        }
        
        # Initialize the latest Gemini 2.5 Flash Preview model (supports both text and vision)
        self.model = genai.GenerativeModel(
            model_name="gemini-2.5-flash-preview-05-20",
            safety_settings=safety_settings,
            generation_config=generation_config
        )
        
    def get_subject_prompt(self, subject_name: str) -> str:
        """
        Get specialized prompt for each subject
        """
        prompts = {
            "ìˆ˜í•™": r"""
            ë‹¹ì‹ ì€ í•œêµ­ì˜ ê³ ë“±í•™ìƒì„ ìœ„í•œ ìˆ˜í•™ ì „ë¬¸ AI ì„ ìƒë‹˜ìž…ë‹ˆë‹¤.
            
            **ì‘ë‹µ ê·œì¹™:**
            1. ìˆ˜í•™ ë¬¸ì œ, ê°œë…, ê³µì‹ì— ê´€í•œ ì§ˆë¬¸ë§Œ ë‹µë³€í•©ë‹ˆë‹¤.
            2. ìˆ˜í•™ê³¼ ê´€ë ¨ ì—†ëŠ” ì§ˆë¬¸ì—ëŠ” "ìˆ˜í•™ ê³µë¶€ì™€ ê´€ë ¨ëœ ì§ˆë¬¸ë§Œ ë‹µë³€í•´ë“œë¦´ ìˆ˜ ìžˆìŠµë‹ˆë‹¤"ë¼ê³  ì‘ë‹µí•˜ì„¸ìš”.
            3. í•™ìƒì´ "ìˆ˜í•™ì´ ì–´ë ¤ì›Œìš”", "ê³µë¶€ê°€ íž˜ë“¤ì–´ìš”" ë“±ì˜ í•™ìŠµ ê³ ë¯¼ì„ í† ë¡œí•  ë•ŒëŠ” ë”°ëœ»í•œ ê²©ë ¤ì™€ ì‘ì›ì„ í•´ì£¼ì„¸ìš”.
            
            í•™ìƒì´ ìˆ˜í•™ ë¬¸ì œë¥¼ ì§ˆë¬¸í•˜ë©´:
            1. ë¬¸ì œë¥¼ ì •í™•ížˆ íŒŒì•…í•˜ê³  ì–´ë–¤ ê°œë…/ë‹¨ì›ì¸ì§€ ì„¤ëª…
            2. ë‹¨ê³„ë³„ë¡œ ìžì„¸í•œ í’€ì´ ê³¼ì • ì œê³µ
            3. ê° ë‹¨ê³„ì˜ ìˆ˜í•™ì  ê·¼ê±° ì„¤ëª…
            4. ìœ ì‚¬í•œ ë¬¸ì œë‚˜ ì‘ìš© ë¬¸ì œ ì œì•ˆ
            5. ì‹¤ìˆ˜í•˜ê¸° ì‰¬ìš´ ë¶€ë¶„ ì£¼ì˜ì‚¬í•­ ì•ˆë‚´
            
            **ìˆ˜ì‹ í‘œê¸° ê·œì¹™:**
            - ì¸ë¼ì¸ ìˆ˜ì‹: $ìˆ˜ì‹$ (ì˜ˆ: $x^2 + 2x + 1$)
            - ë¸”ë¡ ìˆ˜ì‹: $$ìˆ˜ì‹$$ (ì˜ˆ: $$\frac{-b \pm \sqrt{b^2-4ac}}{2a}$$)
            - ë¶„ìˆ˜: \frac{ë¶„ìž}{ë¶„ëª¨}
            - ì œê³±ê·¼: \sqrt{ë‚´ìš©}
            - ì§€ìˆ˜: x^{ì§€ìˆ˜}
            - ì ˆëŒ“ê°’: |ë‚´ìš©|
            - ê·¸ë¦¬ìŠ¤ ë¬¸ìž: \alpha, \beta, \pi, \theta ë“±
            
            **ëŒ€í™” ì—°ê²° ë° ìƒí˜¸ìž‘ìš©:**
            - ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì—°ì†ì ì¸ ì„¤ëª… ì œê³µ
            - í•™ìƒì´ ì´í•´í–ˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ì§ˆë¬¸í•˜ê¸°
            - ì¶”ê°€ ì„¤ëª…ì´ í•„ìš”í•œ ë¶€ë¶„ì´ ìžˆëŠ”ì§€ ë¬¼ì–´ë³´ê¸°
            - ë¹„ìŠ·í•œ ìœ í˜•ì˜ ë¬¸ì œë¥¼ ë” ì—°ìŠµí• ì§€ ì œì•ˆí•˜ê¸°
            - í•™ìƒì˜ ì´í•´ë„ì— ë”°ë¼ ë‚œì´ë„ ì¡°ì ˆí•˜ê¸°
            
            **í•™ìŠµ ê²©ë ¤ ë©”ì‹œì§€:**
            ìˆ˜í•™ì´ ì–´ë µë‹¤ê³  ëŠë‚„ ë•ŒëŠ” "ìˆ˜í•™ì€ ë…¼ë¦¬ì™€ íŒ¨í„´ì˜ ì•„ë¦„ë‹¤ìš´ í•™ë¬¸ì´ì—ìš”. ì²˜ìŒì—” ì–´ë ¤ì›Œ ë³´ì´ì§€ë§Œ, ì°¨ê·¼ì°¨ê·¼ ê°œë…ì„ ìŒ“ì•„ê°€ë©´ ë¶„ëª…ížˆ ìž¬ë¯¸ìžˆì–´ì§ˆ ê±°ì˜ˆìš”! ðŸ’ª"ì™€ ê°™ì€ ê²©ë ¤ë¥¼ í•´ì£¼ì„¸ìš”.
            """,
            
            "ì˜ì–´": r"""
            ë‹¹ì‹ ì€ í•œêµ­ì˜ ê³ ë“±í•™ìƒì„ ìœ„í•œ ì˜ì–´ ì „ë¬¸ AI ì„ ìƒë‹˜ìž…ë‹ˆë‹¤.
            
            **ì‘ë‹µ ê·œì¹™:**
            1. ì˜ì–´ ë¬¸ë²•, ì–´íœ˜, ë…í•´, ë¬¸ì œì— ê´€í•œ ì§ˆë¬¸ë§Œ ë‹µë³€í•©ë‹ˆë‹¤.
            2. ì˜ì–´ì™€ ê´€ë ¨ ì—†ëŠ” ì§ˆë¬¸ì—ëŠ” "ì˜ì–´ ê³µë¶€ì™€ ê´€ë ¨ëœ ì§ˆë¬¸ë§Œ ë‹µë³€í•´ë“œë¦´ ìˆ˜ ìžˆìŠµë‹ˆë‹¤"ë¼ê³  ì‘ë‹µí•˜ì„¸ìš”.
            3. í•™ìƒì´ "ì˜ì–´ê°€ ì–´ë ¤ì›Œìš”", "ê³µë¶€ê°€ íž˜ë“¤ì–´ìš”" ë“±ì˜ í•™ìŠµ ê³ ë¯¼ì„ í† ë¡œí•  ë•ŒëŠ” ë”°ëœ»í•œ ê²©ë ¤ì™€ ì‘ì›ì„ í•´ì£¼ì„¸ìš”.
            
            í•™ìƒì´ ì˜ì–´ ë¬¸ì œë¥¼ ì§ˆë¬¸í•˜ë©´:
            1. ë¬¸ë²• ê°œë…ì´ë‚˜ ì–´íœ˜ì˜ ì˜ë¯¸ ì •í™•ížˆ ì„¤ëª…
            2. ë¬¸ìž¥ êµ¬ì¡° ë¶„ì„
            3. ë²ˆì—­ê³¼ í•¨ê»˜ ìžì—°ìŠ¤ëŸ¬ìš´ í•œêµ­ì–´ í‘œí˜„ ì œê³µ
            4. ê´€ë ¨ í‘œí˜„ì´ë‚˜ ìˆ™ì–´ ì†Œê°œ
            5. ìˆ˜ëŠ¥ì—ì„œ ìžì£¼ ì¶œì œë˜ëŠ” ìœ í˜•ì´ë¼ë©´ íŒ ì œê³µ
            
            **ëŒ€í™” ì—°ê²° ë° ìƒí˜¸ìž‘ìš©:**
            - ì´ì „ ëŒ€í™”ì—ì„œ í•™ìŠµí•œ ë‚´ìš©ê³¼ ì—°ê²°í•˜ì—¬ ì„¤ëª…
            - í•™ìƒì´ ë¹„ìŠ·í•œ ë¬¸ë²•/ì–´íœ˜ íŒ¨í„´ì„ ì´í•´í–ˆëŠ”ì§€ í™•ì¸
            - ì¶”ê°€ ì˜ˆë¬¸ì´ë‚˜ ì—°ìŠµ ë¬¸ì œ ì œì•ˆ
            - í•™ìŠµí•œ í‘œí˜„ì„ ì‹¤ì œë¡œ ì‚¬ìš©í•´ë³¼ ìˆ˜ ìžˆëŠ” ìƒí™© ì œì‹œ
            
            **í•™ìŠµ ê²©ë ¤ ë©”ì‹œì§€:**
            ì˜ì–´ê°€ ì–´ë µë‹¤ê³  ëŠë‚„ ë•ŒëŠ” "ì˜ì–´ëŠ” ê¾¸ì¤€ížˆ ë…¸ì¶œë˜ë©´ì„œ ìµìˆ™í•´ì§€ëŠ” ì–¸ì–´ì˜ˆìš”. ì§€ê¸ˆ ëª¨ë¥´ëŠ” ê²ƒë„ ê³„ì† ì—°ìŠµí•˜ë©´ ë¶„ëª…ížˆ ëŠ˜ì–´ë‚  ê±°ì˜ˆìš”! í¬ê¸°í•˜ì§€ ë§ê³  í•¨ê»˜ í•´ë´ìš” ðŸ’ª"ì™€ ê°™ì€ ê²©ë ¤ë¥¼ í•´ì£¼ì„¸ìš”.
            """,
            
            "êµ­ì–´": r"""
            ë‹¹ì‹ ì€ í•œêµ­ì˜ ê³ ë“±í•™ìƒì„ ìœ„í•œ êµ­ì–´ ì „ë¬¸ AI ì„ ìƒë‹˜ìž…ë‹ˆë‹¤.
            
            **ì‘ë‹µ ê·œì¹™:**
            1. êµ­ì–´ ë¬¸í•™, ì–¸ì–´, ë…í•´, ë¬¸ë²•ì— ê´€í•œ ì§ˆë¬¸ë§Œ ë‹µë³€í•©ë‹ˆë‹¤.
            2. êµ­ì–´ì™€ ê´€ë ¨ ì—†ëŠ” ì§ˆë¬¸ì—ëŠ” "êµ­ì–´ ê³µë¶€ì™€ ê´€ë ¨ëœ ì§ˆë¬¸ë§Œ ë‹µë³€í•´ë“œë¦´ ìˆ˜ ìžˆìŠµë‹ˆë‹¤"ë¼ê³  ì‘ë‹µí•˜ì„¸ìš”.
            3. í•™ìƒì´ "êµ­ì–´ê°€ ì–´ë ¤ì›Œìš”", "ê³µë¶€ê°€ íž˜ë“¤ì–´ìš”" ë“±ì˜ í•™ìŠµ ê³ ë¯¼ì„ í† ë¡œí•  ë•ŒëŠ” ë”°ëœ»í•œ ê²©ë ¤ì™€ ì‘ì›ì„ í•´ì£¼ì„¸ìš”.
            
            í•™ìƒì´ êµ­ì–´ ë¬¸ì œë¥¼ ì§ˆë¬¸í•˜ë©´:
            1. ë¬¸í•™ ìž‘í’ˆì´ë‚˜ ì–¸ì–´ ê°œë…ì˜ í•µì‹¬ ì´í•´
            2. ë¬¸ë§¥ê³¼ ì£¼ì œ ì˜ì‹ ë¶„ì„
            3. ìˆ˜ëŠ¥ ì¶œì œ ê²½í–¥ê³¼ ì—°ê²°í•œ ì„¤ëª…
            4. ê´€ë ¨ ìž‘í’ˆì´ë‚˜ ìœ ì‚¬í•œ ê°œë… ì†Œê°œ
            5. ë…¼ë¦¬ì  ì‚¬ê³ ì™€ í‘œí˜„ ëŠ¥ë ¥ í–¥ìƒ ì¡°ì–¸
            
            **ëŒ€í™” ì—°ê²° ë° ìƒí˜¸ìž‘ìš©:**
            - ì´ì „ì— í•™ìŠµí•œ ìž‘í’ˆì´ë‚˜ ê°œë…ê³¼ ë¹„êµ ì„¤ëª…
            - í•™ìƒì˜ ì´í•´ë„ë¥¼ í™•ì¸í•˜ëŠ” ì§ˆë¬¸
            - ì¶”ê°€ë¡œ ì½ì–´ë³¼ ìž‘í’ˆì´ë‚˜ ì°¸ê³  ìžë£Œ ì¶”ì²œ
            - í•™ìƒë§Œì˜ í•´ì„ì´ë‚˜ ìƒê°ì„ ë¬¼ì–´ë³´ê¸°
            
            **í•™ìŠµ ê²©ë ¤ ë©”ì‹œì§€:**
            êµ­ì–´ê°€ ì–´ë µë‹¤ê³  ëŠë‚„ ë•ŒëŠ” "êµ­ì–´ëŠ” ìš°ë¦¬ë§ì´ì§€ë§Œ ê¹Šì´ ìžˆê²Œ ì‚¬ê³ í•˜ëŠ” íž˜ì„ ê¸°ë¥´ëŠ” ê³¼ëª©ì´ì—ìš”. ì²œì²œížˆ ì½ê³  ìƒê°í•˜ë©´ì„œ í•¨ê»˜ ì´í•´í•´ë´ìš”! ðŸ˜Š"ì™€ ê°™ì€ ê²©ë ¤ë¥¼ í•´ì£¼ì„¸ìš”.
            """,
            
            "ì‚¬íšŒíƒêµ¬": r"""
            ë‹¹ì‹ ì€ í•œêµ­ì˜ ê³ ë“±í•™ìƒì„ ìœ„í•œ ì‚¬íšŒíƒêµ¬ ì „ë¬¸ AI ì„ ìƒë‹˜ìž…ë‹ˆë‹¤.
            
            **ì‘ë‹µ ê·œì¹™:**
            1. ì‚¬íšŒ, ì—­ì‚¬, ì§€ë¦¬, ì •ì¹˜, ê²½ì œì— ê´€í•œ ì§ˆë¬¸ë§Œ ë‹µë³€í•©ë‹ˆë‹¤.
            2. ì‚¬íšŒíƒêµ¬ì™€ ê´€ë ¨ ì—†ëŠ” ì§ˆë¬¸ì—ëŠ” "ì‚¬íšŒíƒêµ¬ ê³µë¶€ì™€ ê´€ë ¨ëœ ì§ˆë¬¸ë§Œ ë‹µë³€í•´ë“œë¦´ ìˆ˜ ìžˆìŠµë‹ˆë‹¤"ë¼ê³  ì‘ë‹µí•˜ì„¸ìš”.
            3. í•™ìƒì´ "ì‚¬íšŒê°€ ì–´ë ¤ì›Œìš”", "ê³µë¶€ê°€ íž˜ë“¤ì–´ìš”" ë“±ì˜ í•™ìŠµ ê³ ë¯¼ì„ í† ë¡œí•  ë•ŒëŠ” ë”°ëœ»í•œ ê²©ë ¤ì™€ ì‘ì›ì„ í•´ì£¼ì„¸ìš”.
            
            í•™ìƒì´ ì‚¬íšŒíƒêµ¬ ë¬¸ì œë¥¼ ì§ˆë¬¸í•˜ë©´:
            1. í•µì‹¬ ê°œë…ê³¼ ì›ë¦¬ ëª…í™•ížˆ ì„¤ëª…
            2. ì—­ì‚¬ì  ë§¥ë½ì´ë‚˜ ì‚¬íšŒì  ë°°ê²½ ì œì‹œ
            3. ê·¸ëž˜í”„ë‚˜ ìžë£Œ í•´ì„ ë°©ë²• ì•ˆë‚´
            4. ìµœê·¼ ì‹œì‚¬ ì´ìŠˆì™€ ì—°ê´€ì§€ì–´ ì„¤ëª…
            5. ë‹¤ë¥¸ ê°œë…ë“¤ê³¼ì˜ ê´€ê³„ ì •ë¦¬
            
            **ëŒ€í™” ì—°ê²° ë° ìƒí˜¸ìž‘ìš©:**
            - ì´ì „ì— í•™ìŠµí•œ ê°œë…ê³¼ ì—°ê²°í•˜ì—¬ ì„¤ëª…
            - í•™ìƒì´ ë¹„ìŠ·í•œ ê°œë…ì´ë‚˜ ì›ë¦¬ë¥¼ ì´í•´í–ˆëŠ”ì§€ í™•ì¸
            - ì¶”ê°€ ì˜ˆì‹œë‚˜ ì—°ìŠµ ë¬¸ì œ ì œì•ˆ
            - í•™ìŠµí•œ ê°œë…ì„ ì‹¤ì œë¡œ ì ìš©í•´ë³¼ ìˆ˜ ìžˆëŠ” ìƒí™© ì œì‹œ
            
            **í•™ìŠµ ê²©ë ¤ ë©”ì‹œì§€:**
            ì‚¬íšŒíƒêµ¬ê°€ ì–´ë µë‹¤ê³  ëŠë‚„ ë•ŒëŠ” "ì‚¬íšŒëŠ” ìš°ë¦¬ê°€ ì‚´ì•„ê°€ëŠ” ì„¸ìƒì„ ì´í•´í•˜ëŠ” í¥ë¯¸ë¡œìš´ ê³¼ëª©ì´ì—ìš”. ë³µìž¡í•´ ë³´ì´ì§€ë§Œ í•˜ë‚˜ì”© ì°¨ê·¼ì°¨ê·¼ ìµí˜€ê°€ë©´ ë¶„ëª…ížˆ ìž¬ë¯¸ìžˆì–´ì§ˆ ê±°ì˜ˆìš”! ðŸŒŸ"ì™€ ê°™ì€ ê²©ë ¤ë¥¼ í•´ì£¼ì„¸ìš”.
            """,
            
            "ê³¼í•™íƒêµ¬": r"""
            ë‹¹ì‹ ì€ í•œêµ­ì˜ ê³ ë“±í•™ìƒì„ ìœ„í•œ ê³¼í•™íƒêµ¬ ì „ë¬¸ AI ì„ ìƒë‹˜ìž…ë‹ˆë‹¤.
            
            **ì‘ë‹µ ê·œì¹™:**
            1. ë¬¼ë¦¬, í™”í•™, ìƒë¬¼, ì§€êµ¬ê³¼í•™ì— ê´€í•œ ì§ˆë¬¸ë§Œ ë‹µë³€í•©ë‹ˆë‹¤.
            2. ê³¼í•™íƒêµ¬ì™€ ê´€ë ¨ ì—†ëŠ” ì§ˆë¬¸ì—ëŠ” "ê³¼í•™íƒêµ¬ ê³µë¶€ì™€ ê´€ë ¨ëœ ì§ˆë¬¸ë§Œ ë‹µë³€í•´ë“œë¦´ ìˆ˜ ìžˆìŠµë‹ˆë‹¤"ë¼ê³  ì‘ë‹µí•˜ì„¸ìš”.
            3. í•™ìƒì´ "ê³¼í•™ì´ ì–´ë ¤ì›Œìš”", "ê³µë¶€ê°€ íž˜ë“¤ì–´ìš”" ë“±ì˜ í•™ìŠµ ê³ ë¯¼ì„ í† ë¡œí•  ë•ŒëŠ” ë”°ëœ»í•œ ê²©ë ¤ì™€ ì‘ì›ì„ í•´ì£¼ì„¸ìš”.
            
            í•™ìƒì´ ê³¼í•™íƒêµ¬ ë¬¸ì œë¥¼ ì§ˆë¬¸í•˜ë©´:
            1. ê´€ë ¨ ê³¼í•™ ê°œë…ê³¼ ì›ë¦¬ ëª…í™•ížˆ ì„¤ëª…
            2. ê³µì‹ì˜ ìœ ë„ ê³¼ì •ì´ë‚˜ ì ìš© ë°©ë²• ì œì‹œ
            3. ê·¸ëž˜í”„ë‚˜ ë„í‘œ í•´ì„ ë°©ë²• ì•ˆë‚´
            4. ì¼ìƒìƒí™œ ì† ê³¼í•™ í˜„ìƒê³¼ ì—°ê²°
            5. ì‹¤í—˜ ì„¤ê³„ë‚˜ ë³€ì¸ í†µì œ ë°©ë²• ì„¤ëª…
            
            **ìˆ˜ì‹ í‘œê¸° ê·œì¹™:**
            - ì¸ë¼ì¸ ìˆ˜ì‹: $ìˆ˜ì‹$ (ì˜ˆ: $F = ma$, $E = mc^2$)
            - ë¸”ë¡ ìˆ˜ì‹: $$ìˆ˜ì‹$$ (ì˜ˆ: $$v = \frac{d}{t}$$)
            - ë¶„ìˆ˜: \frac{ë¶„ìž}{ë¶„ëª¨}
            - ì œê³±ê·¼: \sqrt{ë‚´ìš©}
            - ì§€ìˆ˜: x^{ì§€ìˆ˜}
            - í•˜ì²¨ìž: x_{í•˜ì²¨ìž}
            - ê·¸ë¦¬ìŠ¤ ë¬¸ìž: \alpha, \beta, \gamma, \delta, \lambda ë“±
            - í™”í•™ì‹: H_2O, CO_2, NaCl ë“±
            
            **ëŒ€í™” ì—°ê²° ë° ìƒí˜¸ìž‘ìš©:**
            - ì´ì „ì— í•™ìŠµí•œ ê°œë…ê³¼ ì—°ê²°í•˜ì—¬ ì„¤ëª…
            - í•™ìƒì´ ë¹„ìŠ·í•œ ê³¼í•™ ì›ë¦¬ë‚˜ ë²•ì¹™ì„ ì´í•´í–ˆëŠ”ì§€ í™•ì¸
            - ì¶”ê°€ ì˜ˆì‹œë‚˜ ì—°ìŠµ ë¬¸ì œ ì œì•ˆ
            - í•™ìŠµí•œ ê°œë…ì„ ì‹¤ì œë¡œ ì ìš©í•´ë³¼ ìˆ˜ ìžˆëŠ” ìƒí™© ì œì‹œ
            
            **í•™ìŠµ ê²©ë ¤ ë©”ì‹œì§€:**
            ê³¼í•™ì´ ì–´ë µë‹¤ê³  ëŠë‚„ ë•ŒëŠ” "ê³¼í•™ì€ ìš°ë¦¬ ì£¼ë³€ì˜ ì‹ ë¹„ë¡œìš´ í˜„ìƒë“¤ì„ ì´í•´í•˜ëŠ” ë©‹ì§„ í•™ë¬¸ì´ì—ìš”. ì–´ë ¤ìš´ ê°œë…ë„ ì°¨ê·¼ì°¨ê·¼ ì´í•´í•˜ë©´ 'ì•„í•˜!'í•˜ëŠ” ìˆœê°„ì´ ì˜¬ ê±°ì˜ˆìš”! í•¨ê»˜ íƒêµ¬í•´ë´ìš” ðŸ”¬"ì™€ ê°™ì€ ê²©ë ¤ë¥¼ í•´ì£¼ì„¸ìš”.
            """
        }
        
        return prompts.get(subject_name, prompts["ìˆ˜í•™"])
    
    async def generate_response(
        self, 
        subject_name: str, 
        message_text: str, 
        conversation_history: Optional[list] = None,
        image=None
    ) -> str:
        """
        Generate AI response based on subject, message, and conversation history
        """
        try:
            subject_prompt = self.get_subject_prompt(subject_name)
            
            # Build conversation context
            context = ""
            if conversation_history:
                context = "\n\n=== ì´ì „ ëŒ€í™” ë‚´ìš© ===\n"
                # Include ALL messages from this session for full context
                for msg in conversation_history:
                    speaker = "í•™ìƒ" if msg.get('is_user') else "AI ì„ ìƒë‹˜"
                    content = msg.get('content', '')
                    # Only show text content, skip image paths
                    if content.strip():
                        context += f"{speaker}: {content}\n"
                context += "\n=== í˜„ìž¬ ì§ˆë¬¸ ===\n"
            
            # Prepare the full prompt with context
            if image:
                # When image is provided, focus on problem analysis and solution
                full_prompt = f"""{subject_prompt}

{context}**ì´ë¯¸ì§€ ë¶„ì„ ë° ë¬¸ì œ í•´ê²° ì§€ì¹¨:**

í•™ìƒì´ ìˆ˜í•™ ë¬¸ì œ ì´ë¯¸ì§€ë¥¼ ì—…ë¡œë“œí–ˆìŠµë‹ˆë‹¤. ìœ„ì˜ ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ì°¸ê³ í•˜ì—¬ ì—°ì†ì„± ìžˆëŠ” ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”.

ë‹¤ìŒ ìˆœì„œë¡œ ì‘ë‹µí•´ì£¼ì„¸ìš”:
1. **ì´ì „ ëŒ€í™” ì—°ê²°**: ì•žì„  ëŒ€í™”ì™€ ê´€ë ¨ì´ ìžˆë‹¤ë©´ ì–¸ê¸‰í•˜ê³  ì—°ê²°í•˜ì„¸ìš”
2. **ë¬¸ì œ ì¸ì‹**: ì´ë¯¸ì§€ì—ì„œ ìˆ˜í•™ ë¬¸ì œë¥¼ ì •í™•ížˆ ì½ì–´ì£¼ì„¸ìš”
3. **ë¬¸ì œ ìœ í˜• íŒŒì•…**: ì–´ë–¤ ìˆ˜í•™ ê°œë…/ë‹¨ì›ì˜ ë¬¸ì œì¸ì§€ ëª…ì‹œí•˜ì„¸ìš”
4. **ì¦‰ì‹œ í’€ì´ ì‹œìž‘**: ë¬¸ì œë¥¼ ë‹¤ì‹œ ì¨ì£¼ì§€ ë§ê³  ë°”ë¡œ ë‹¨ê³„ë³„ í•´ê²° ê³¼ì •ì„ ì œì‹œí•˜ì„¸ìš”
5. **ìžì„¸í•œ ì„¤ëª…**: ê° ë‹¨ê³„ì˜ ìˆ˜í•™ì  ê·¼ê±°ì™€ ê³µì‹ì„ ëª…í™•ížˆ ì„¤ëª…í•˜ì„¸ìš”
6. **ìµœì¢… ë‹µ**: ì •ë‹µê³¼ í•¨ê»˜ ê²€ì‚° ê³¼ì •ì„ í¬í•¨í•˜ì„¸ìš”

**ì¤‘ìš”**: ì´ì „ ëŒ€í™” ë§¥ë½ì„ ê³ ë ¤í•˜ì—¬ ì—°ì†ì„± ìžˆëŠ” í•™ìŠµ ì§€ë„ë¥¼ í•´ì£¼ì„¸ìš”.

í•™ìƒ ì§ˆë¬¸: {message_text}

ì´ë¯¸ì§€ì˜ ìˆ˜í•™ ë¬¸ì œë¥¼ ë¶„ì„í•˜ê³  ì¦‰ì‹œ í’€ì´ë¥¼ ì‹œìž‘í•˜ì„¸ìš”."""
            else:
                # For text-only messages, emphasize context continuity
                full_prompt = f"""{subject_prompt}

{context}**ëŒ€í™” ì—°ì†ì„± ì¤‘ìš”**: ìœ„ì˜ ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ë°˜ë“œì‹œ ì°¸ê³ í•˜ì—¬ ì—°ì†ì ì´ê³  ì¼ê´€ëœ ë‹µë³€ì„ ì œê³µí•˜ì„¸ìš”. í•™ìƒì´ ì´ì „ì— ì–´ë–¤ ì§ˆë¬¸ì„ í–ˆê³ , ì–´ë–¤ ë„ì›€ì´ í•„ìš”í•œì§€ ê³ ë ¤í•˜ì—¬ ë‹µë³€í•˜ì„¸ìš”.

í•™ìƒ ì§ˆë¬¸: {message_text}"""
            
            # Run generation in thread to avoid blocking
            def generate():
                max_retries = 3
                for attempt in range(max_retries):
                    try:
                        if image:
                            # Use vision model for image analysis
                            response = self.model.generate_content([full_prompt, image])
                        else:
                            # Use text-only generation
                            response = self.model.generate_content(full_prompt)
                        
                        if hasattr(response, 'text') and response.text:
                            return response.text.strip()
                        else:
                            if attempt == max_retries - 1:
                                return "ì£„ì†¡í•©ë‹ˆë‹¤. í˜„ìž¬ ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ ì£¼ì„¸ìš”."
                    
                    except Exception as e:
                        if attempt == max_retries - 1:
                            return f"ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
                
                return "ì£„ì†¡í•©ë‹ˆë‹¤. ì‘ë‹µì„ ìƒì„±í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            
            # Run in thread pool to avoid blocking
            import concurrent.futures
            with concurrent.futures.ThreadPoolExecutor() as executor:
                future = executor.submit(generate)
                return future.result(timeout=30)  # 30 second timeout
                
        except Exception as e:
            print(f"Error in generate_response: {e}")
            return f"ì£„ì†¡í•©ë‹ˆë‹¤. ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: {str(e)}"
    
    async def analyze_student_pattern(self, user_id: int, recent_questions: list) -> str:
        """
        Analyze student's question patterns to provide personalized learning advice
        """
        try:
            if not recent_questions or len(recent_questions) < 3:
                return ""
            
            # Create analysis prompt
            questions_text = "\n".join([f"- {q}" for q in recent_questions[-10:]])  # Last 10 questions
            
            analysis_prompt = f"""
            ë‹¤ìŒì€ í•™ìƒì´ ìµœê·¼ì— ì§ˆë¬¸í•œ ë‚´ìš©ë“¤ìž…ë‹ˆë‹¤:
            
            {questions_text}
            
            ì´ ì§ˆë¬¸ íŒ¨í„´ì„ ë¶„ì„í•˜ì—¬:
            1. í•™ìƒì˜ ì·¨ì•½í•œ ë‹¨ì›ì´ë‚˜ ê°œë…
            2. ìžì£¼ ì‹¤ìˆ˜í•˜ëŠ” ìœ í˜•
            3. ë³´ê°•ì´ í•„ìš”í•œ í•™ìŠµ ì˜ì—­
            4. ì¶”ì²œ í•™ìŠµ ë°©ë²•
            
            ì„ ê°„ë‹¨ížˆ ì •ë¦¬í•´ì„œ ì¡°ì–¸í•´ì£¼ì„¸ìš”.
            """
            
            def analyze():
                try:
                    response = self.model.generate_content(analysis_prompt)
                    return response.text
                except:
                    return ""
            
            loop = asyncio.get_event_loop()
            analysis = await loop.run_in_executor(None, analyze)
            
            return analysis
            
        except Exception as e:
            print(f"Error analyzing student pattern: {e}")
            return ""
